name: edgex-pi
version: 18-1
summary: Raspberry Pi gadget for EdgeX
description: |
  Gadget snap for EdgeX Community Development Kit to support the Grove sensor
  kit.
type: gadget
base: core18
architectures:
  - build-on: amd64
    run-on: arm64
confinement: strict
grade: stable
parts:
  local-assets:
    source: .
    plugin: dump
    organize:
      psplash/psplash.patch: patches/psplash.patch
      uboot.patch: patches/uboot.patch
      uboot3.patch: patches/uboot3.patch
    stage:
      - patches/
      - psplash/
      - uboot.env.in
    prime: [-*]
  uboot-pi3:
    after: [local-assets]
    plugin: nil
    source: git://git.denx.de/u-boot.git
    source-tag: v2018.07-rc3
    override-build: |
      git apply $SNAPCRAFT_STAGE/patches/uboot3.patch
      make rpi_3_defconfig
      CROSS_COMPILE=aarch64-linux-gnu- make
      mkdir -p $SNAPCRAFT_PART_INSTALL/boot-assets
      cp u-boot.bin $SNAPCRAFT_PART_INSTALL/boot-assets/kernel8.img
      tools/mkenvimage -r -s 131072 -o $SNAPCRAFT_PART_INSTALL/uboot.env $SNAPCRAFT_STAGE/uboot.env.in
      ln -s uboot.env $SNAPCRAFT_PART_INSTALL/uboot.conf
    build-packages:
      - bison
      - flex
      - bc
      - build-essential
      - device-tree-compiler
      - html2text
      - libpython2.7-dev
      - python-minimal
      - on amd64:
        - gcc-aarch64-linux-gnu:amd64
  boot-firmware:
    plugin: nil
    source: .
    after:
      - uboot-pi3
    override-build: |
      git clone --depth=1 https://github.com/raspberrypi/firmware.git -b "1.20180919"
      mkdir -p $SNAPCRAFT_PART_INSTALL/boot-assets
      for file in fixup start bootcode LICENCE COPYING; do
        cp firmware/boot/${file}* $SNAPCRAFT_PART_INSTALL/boot-assets
      done
  configs:
    plugin: dump
    source: configs
    after:
      - boot-firmware
    organize:
      config.txt: boot-assets/config.txt
      cmdline.txt: boot-assets/cmdline.txt
  devicetrees:
    plugin: nil
    source: .
    after:
      - configs
    override-build: |
      PACKAGES="http://ports.ubuntu.com/ubuntu-ports/dists/bionic-updates/universe/binary-arm64/Packages.gz"
      PKGPATH="$(wget -q -O- $PACKAGES|zcat|grep-dctrl linux-raspi2 |\
        grep linux-modules|grep Filename|tail -1| sed 's/^Filename: //')"
      wget http://ports.ubuntu.com/ubuntu-ports/$PKGPATH
      dpkg -x $(basename $PKGPATH) unpack/
      mkdir -p $SNAPCRAFT_PART_INSTALL/boot-assets
      cp -a unpack/lib/firmware/*/device-tree/* $SNAPCRAFT_PART_INSTALL/boot-assets
      # 64bit uboot needs this for some reason
      cp -a unpack/lib/firmware/*/device-tree/broadcom/*.dtb $SNAPCRAFT_PART_INSTALL/boot-assets
      rm -rf unpack
    build-packages:
      - coreutils
      - dctrl-tools
      - sed
      - wget
      - on amd64:
        - gcc-aarch64-linux-gnu:amd64
        - libc6-dev-arm64-cross:amd64
  psplash:
    after: [local-assets]
    source: git://git.yoctoproject.org/psplash
    plugin: nil
    override-build: |
      set -x
      export TREE="$SNAPCRAFT_STAGE/psplash"
      . ${TREE}/config
      if ! $(echo "$FONT"|grep -q ^/); then
         FONT="${TREE}/${FONT}"
      fi
      if ! $(echo "$SPLASH"|grep -q ^/); then
         SPLASH="${TREE}/${SPLASH}"
      fi
      git apply $SNAPCRAFT_STAGE/patches/psplash.patch
      ${TREE}/font-gen.sh "$FONT"
      ./make-image-header.sh "$SPLASH" CORE psplash-core
      aclocal
      autoreconf --install
      ./configure --build=x86_64-linux-gnu --host=aarch64-linux-gnu CC=/usr/bin/aarch64-linux-gnu-gcc || cat config.log
      CROSS_COMPILE=aarch64-linux-gnu- ARCH=arm64 make
      rm -rf $SNAPCRAFT_PART_INSTALL/usr
      cp -a "$TREE/initrd" .
      mkdir -p initrd/bin
      cp psplash initrd/bin
      mkdir -p $SNAPCRAFT_PART_INSTALL/boot-assets
      cd initrd && find . | cpio --quiet -o -H newc| lzma >>$SNAPCRAFT_PART_INSTALL/boot-assets/psplash.img
    build-packages:
      - libgdk-pixbuf2.0-dev
      - automake
      - autoconf
      - gcc
      - otf2bdf
      - libbogl-dev
      - ttf-ubuntu-font-family
      - cpio
      - findutils
      - xz-utils
      - on amd64 to armhf:
        - gcc-aarch64-linux-gnu:amd64


slots:
  bcm-gpio-0:
    interface: gpio
    number: 0
  bcm-gpio-1:
    interface: gpio
    number: 1
  bcm-gpio-2:
    interface: gpio
    number: 2
  bcm-gpio-3:
    interface: gpio
    number: 3
  bcm-gpio-4:
    interface: gpio
    number: 4
  bcm-gpio-5:
    interface: gpio
    number: 5
  bcm-gpio-6:
    interface: gpio
    number: 6
  bcm-gpio-7:
    interface: gpio
    number: 7
  bcm-gpio-8:
    interface: gpio
    number: 8
  bcm-gpio-9:
    interface: gpio
    number: 9
  bcm-gpio-10:
    interface: gpio
    number: 10
  bcm-gpio-11:
    interface: gpio
    number: 11
  bcm-gpio-12:
    interface: gpio
    number: 12
  bcm-gpio-13:
    interface: gpio
    number: 13
  bcm-gpio-14:
    interface: gpio
    number: 14
  bcm-gpio-15:
    interface: gpio
    number: 15
  bcm-gpio-16:
    interface: gpio
    number: 16
  bcm-gpio-17:
    interface: gpio
    number: 17
  bcm-gpio-18:
    interface: gpio
    number: 18
  bcm-gpio-19:
    interface: gpio
    number: 19
  bcm-gpio-20:
    interface: gpio
    number: 20
  bcm-gpio-21:
    interface: gpio
    number: 21
  bcm-gpio-22:
    interface: gpio
    number: 22
  bcm-gpio-23:
    interface: gpio
    number: 23
  bcm-gpio-24:
    interface: gpio
    number: 24
  bcm-gpio-25:
    interface: gpio
    number: 25
  bcm-gpio-26:
    interface: gpio
    number: 26
  bcm-gpio-27:
    interface: gpio
    number: 27
  i2c-0:
    interface: i2c
    path: /dev/i2c-0
  i2c-1:
    interface: i2c
    path: /dev/i2c-1
  i2c-2:
    interface: i2c
    path: /dev/i2c-2
